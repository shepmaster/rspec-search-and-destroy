#!/usr/bin/env ruby

require 'rspec-sad'

require 'rspec-search-and-destroy/binary_chop_example_selector'
require 'rspec-search-and-destroy/rspec_driver'
require 'rspec-search-and-destroy/bisector'

include RSpecSearchAndDestroy

class TTYOutput
  def found(causal_example, failed_example)
    puts "Culprit found"
    puts "Run    #{causal_example[:location]}"
    puts "Before #{failed_example[:location]}"
  end
end

require 'optparse'

driver_options = {}

option_parser = OptionParser.new do |opts|
  opts.banner = <<BANNER
Find RSpec test order bugs

Usage: #{opts.program_name} [options]

BANNER

  opts.on("--rspec-command COMMAND",
          "Command to run instead of `rspec`") do |cmd|
    driver_options[:command] = cmd
  end
end
option_parser.parse!


output = TTYOutput.new
selector = BinaryChopExampleSelector.new
driver = RSpecDriver.new(driver_options)

driver.initial_run
results = driver.load_run_results
raise "no failures found" unless results.failed?

bisector = Bisector.new(output, selector, driver)
bisector.bisect(results.causal_examples, results.failed_example)

driver.cleanup
